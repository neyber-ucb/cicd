name: CD - Staging + Production

on:
  push:
    branches: ["master"]
    tags: ["v*"]
  workflow_dispatch:

env:
  RELEASE_ID: ${{ github.sha }}-${{ github.run_number }}

jobs:
  build:
    name: Build Release Artifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Build backend
        working-directory: ./backend
        run: |
          uv sync --frozen
          uv export --no-dev > requirements.txt
      
      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build
      
      - name: Create release metadata
        run: |
          echo "RELEASE_ID=${{ env.RELEASE_ID }}" > RELEASE_INFO
          echo "COMMIT_SHA=${{ github.sha }}" >> RELEASE_INFO
          echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> RELEASE_INFO
          echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> RELEASE_INFO
          echo "GITHUB_REF=${{ github.ref }}" >> RELEASE_INFO
          echo "GITHUB_ACTOR=${{ github.actor }}" >> RELEASE_INFO
      
      - name: Package release artifact
        run: |
          mkdir -p release
          cp -r backend release/
          cp -r frontend/dist release/frontend-dist
          cp RELEASE_INFO release/
          tar -czf release-${{ env.RELEASE_ID }}.tar.gz release/
      
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ env.RELEASE_ID }}
          path: release-${{ env.RELEASE_ID }}.tar.gz
          retention-days: 30

  deploy_staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment: staging
    needs: [build]
    
    steps:
      - name: Download release artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ env.RELEASE_ID }}
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.STAGING_PORT }} -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts || true
      
      - name: Deploy to staging server
        run: |
          RELEASE="${{ env.RELEASE_ID }}"
          
          # Create release directory on server
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.STAGING_PORT }} ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            "mkdir -p /var/www/taskmanager-staging/releases/$RELEASE"
          
          # Upload artifact
          scp -i ~/.ssh/deploy_key -P ${{ secrets.STAGING_PORT }} release-${{ env.RELEASE_ID }}.tar.gz \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/var/www/taskmanager-staging/releases/$RELEASE/
          
          # Extract and setup on server
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.STAGING_PORT }} ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << ENDSSH
            cd /var/www/taskmanager-staging/releases/$RELEASE
            tar -xzf release-${{ env.RELEASE_ID }}.tar.gz
            mv release/* .
            rmdir release
            rm release-${{ env.RELEASE_ID }}.tar.gz
            
            # Setup backend
            cd backend
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
            pip install fastapi uvicorn sqlalchemy passlib python-jose bcrypt python-multipart email-validator pydantic-settings alembic
            
            # Link .env
            ln -sf /var/www/taskmanager-staging/shared/.env .env
            
            # Run migrations
            alembic upgrade head || echo "No migrations to run"
            
            # Atomic symlink switch
            ln -sfn /var/www/taskmanager-staging/releases/$RELEASE /var/www/taskmanager-staging/current
            
            # Kill existing server and start new one
            pkill -f "uvicorn main:app.*8001" || true
            cd /var/www/taskmanager-staging/current/backend
            source venv/bin/activate
            RELEASE_ID=$RELEASE ENVIRONMENT=staging nohup uvicorn main:app --host 0.0.0.0 --port 8001 > /tmp/staging.log 2>&1 &
            
            echo "✅ Staging deployment completed"
          ENDSSH
      
      - name: Health check staging
        run: |
          sleep 5
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.STAGING_PORT }} ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            "curl -f http://localhost:8001/api/health" || exit 1
          echo "✅ Staging health check passed"
      
      - name: Notify deployment
        if: always()
        run: |
          echo "Staging deployment completed for release ${{ env.RELEASE_ID }}"

  deploy_production:
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    needs: [build]
    
    steps:
      - name: Download release artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ env.RELEASE_ID }}
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.PROD_PORT }} -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts || true
      
      - name: Deploy to production server
        run: |
          RELEASE="${{ env.RELEASE_ID }}"
          
          # Create release directory on server
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.PROD_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} \
            "mkdir -p /var/www/taskmanager-production/releases/$RELEASE"
          
          # Upload artifact
          scp -i ~/.ssh/deploy_key -P ${{ secrets.PROD_PORT }} release-${{ env.RELEASE_ID }}.tar.gz \
            ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:/var/www/taskmanager-production/releases/$RELEASE/
          
          # Extract and setup on server
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.PROD_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << ENDSSH
            cd /var/www/taskmanager-production/releases/$RELEASE
            tar -xzf release-${{ env.RELEASE_ID }}.tar.gz
            mv release/* .
            rmdir release
            rm release-${{ env.RELEASE_ID }}.tar.gz
            
            # Setup backend
            cd backend
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
            pip install fastapi uvicorn sqlalchemy passlib python-jose bcrypt python-multipart email-validator pydantic-settings alembic
            
            # Link .env
            ln -sf /var/www/taskmanager-production/shared/.env .env
            
            # Run migrations
            alembic upgrade head || echo "No migrations to run"
            
            # Atomic symlink switch
            ln -sfn /var/www/taskmanager-production/releases/$RELEASE /var/www/taskmanager-production/current
            
            # Kill existing server and start new one
            pkill -f "uvicorn main:app.*8002" || true
            cd /var/www/taskmanager-production/current/backend
            source venv/bin/activate
            RELEASE_ID=$RELEASE ENVIRONMENT=production nohup uvicorn main:app --host 0.0.0.0 --port 8002 > /tmp/production.log 2>&1 &
            
            echo "✅ Production deployment completed"
          ENDSSH
      
      - name: Health check production
        run: |
          sleep 5
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.PROD_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} \
            "curl -f http://localhost:8002/api/health" || exit 1
          echo "✅ Production health check passed"
      
      - name: Notify deployment
        if: always()
        run: |
          echo "Production deployment completed for release ${{ env.RELEASE_ID }}"
          echo "Approved by: ${{ github.actor }}"

  rollback_staging:
    name: Rollback Staging
    if: failure() && needs.deploy_staging.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy_staging]
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.STAGING_PORT }} -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts || true
      
      - name: Rollback to previous release
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.STAGING_PORT }} ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'ENDSSH'
            cd /var/www/taskmanager-staging/releases
            PREV=$(ls -1dt */ | sed -n '2p' | tr -d '/')
            
            if [ -n "$PREV" ]; then
              echo "Rolling back to: $PREV"
              ln -sfn /var/www/taskmanager-staging/releases/$PREV /var/www/taskmanager-staging/current
              echo "✅ Rollback successful"
            else
              echo "❌ No previous release found"
              exit 1
            fi
          ENDSSH
      
      - name: Verify rollback
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.STAGING_PORT }} ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'ENDSSH'
            pkill -f "uvicorn main:app.*8001" || true
            cd /var/www/taskmanager-staging/current/backend
            source venv/bin/activate
            RELEASE_ID=$(cat ../../RELEASE_INFO | grep RELEASE_ID | cut -d= -f2) ENVIRONMENT=staging nohup uvicorn main:app --host 0.0.0.0 --port 8001 > /tmp/staging.log 2>&1 &
            sleep 5
            curl -f http://localhost:8001/api/health || exit 1
          ENDSSH

  rollback_production:
    name: Rollback Production
    if: failure() && needs.deploy_production.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy_production]
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.PROD_PORT }} -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts || true
      
      - name: Rollback to previous release
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.PROD_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            cd /var/www/taskmanager-production/releases
            PREV=$(ls -1dt */ | sed -n '2p' | tr -d '/')
            
            if [ -n "$PREV" ]; then
              echo "Rolling back to: $PREV"
              ln -sfn /var/www/taskmanager-production/releases/$PREV /var/www/taskmanager-production/current
              echo "✅ Rollback successful"
            else
              echo "❌ No previous release found"
              exit 1
            fi
          ENDSSH
      
      - name: Verify rollback
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.PROD_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'ENDSSH'
            pkill -f "uvicorn main:app.*8002" || true
            cd /var/www/taskmanager-production/current/backend
            source venv/bin/activate
            RELEASE_ID=$(cat ../../RELEASE_INFO | grep RELEASE_ID | cut -d= -f2) ENVIRONMENT=production nohup python -m uvicorn main:app --host 0.0.0.0 --port 8002 > /tmp/production.log 2>&1 &
            sleep 5
            curl -f http://localhost:8002/api/health || exit 1
          ENDSSH
